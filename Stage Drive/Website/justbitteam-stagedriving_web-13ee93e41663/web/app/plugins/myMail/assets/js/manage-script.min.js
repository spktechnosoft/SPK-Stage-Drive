jQuery(document).ready(function(e){var o=e(".import-status"),a=e(".export-status"),f=e("#progress"),g=f.find(".bar"),h=e("#mymail_nonce").val(),m=null,k=0,p,n,l=function(){var s=new plupload.Uploader(wpUploaderInit);s.bind("Init",function(t){var u=e("#plupload-upload-ui");if(t.features.dragdrop&&!e(document.body).hasClass("mobile")){u.addClass("drag-drop");e("#drag-drop-area").bind("dragover.wp-uploader",function(){u.addClass("drag-over")}).bind("dragleave.wp-uploader, drop.wp-uploader",function(){u.removeClass("drag-over")})}else{u.removeClass("drag-drop");e("#drag-drop-area").unbind(".wp-uploader")}if(t.runtime=="html4"){e(".upload-flash-bypass").hide()}});s.bind("FilesAdded",function(t,u){e("#media-upload-error").html("");e("#wordpress-users").fadeOut();setTimeout(function(){t.refresh();t.start()},1)});s.bind("BeforeUpload",function(t,u){f.show().removeClass("finished error");o.html("uploading")});s.bind("UploadFile",function(t,u){});s.bind("UploadProgress",function(t,u){o.html(i(mymailL10n.uploading,u.percent+"%"));g.stop().animate({width:u.percent+"%"},100)});s.bind("Error",function(t,u){o.html(u.message);f.addClass("error");t.refresh()});s.bind("FileUploaded",function(t,v,u){u=e.parseJSON(u.response);n=u.identifier});s.bind("UploadComplete",function(t,u){o.html(mymailL10n.prepare_data);f.addClass("finished");d()});s.init()};if(typeof(wpUploaderInit)=="object"){l()}e(".wrap").on("change","#signup",function(){e("#signupdate").prop("disabled",!e(this).is(":checked"))}).on("click",".do-import",function(){var C=e("#lists").serialize(),u=e("#subscriber-table").serialize();if(!/%5D=email/.test(u)){alert(mymailL10n.select_emailcolumn);return false}if(!C){alert(mymailL10n.no_lists);return false}if(!e('input[name="status"]:checked').length){alert(mymailL10n.select_status);return false}if(!confirm(mymailL10n.confirm_import)){return false}var w=e(this).prop("disabled",true),v=e('input[name="status"]:checked').val(),s=e('input[name="existing"]:checked').val(),y=e("#signup").is(":checked"),t=e("#signupdate").val(),B=e("#keepstatus").is(":checked"),A=e("#import-ajax-loading").css({display:"inline-block"}),x=e("#identifier").val(),z=e("#performance").is(":checked");f.show();g.stop().width(0);e(".step1").slideUp();e(".step2-body").html("<br><br>").parent().show();p=new Date();q(0,{identifier:x,order:u,lists:C,status:v,keepstatus:B,existing:s,signupdate:y?t:null,performance:z});o.html(i(mymailL10n.import_contacts,""));window.onbeforeunload=function(){return mymailL10n.onbeforeunloadimport}}).on("click",".wordpress-users-toggle",function(){e(this).parent().parent().parent().find("li input").prop("checked",e(this).prop("checked"))}).on("click","#addlist",function(){var s=e("#new_list_name").val();if(!s){return false}e('<li><label><input name="lists[]" value="'+s+'" type="checkbox" checked> '+s+" </label></li>").appendTo("#lists > ul");e("#new_list_name").val("")});e("#paste-import").on("focus",function(){e(this).val("").addClass("focus")}).on("blur",function(){e(this).removeClass("focus");var s=e.trim(e(this).val());if(s){b("import_subscribers_upload_handler",{data:s},function(t){if(t.success){n=t.identifier;e("#wordpress-users").fadeOut();d()}},function(){o.html("Error")})}});e("#import_wordpress").on("submit",function(){var s=e(this).serialize();b("import_subscribers_upload_handler",{wordpressusers:s},function(t){if(t.success){n=t.identifier;e("#wordpress-users").fadeOut();d()}},function(){o.html("Error")});return false});e(".export-order").sortable({containment:"parent"});e("#export-subscribers").on("submit",function(){var s=e(this).serialize();f.show().removeClass("finished error");e(".step1").slideUp();e(".step2").slideDown();e(".step2-body").html(i(mymailL10n.write_file,"0.00 Kb"));b("export_contacts",{data:s},function(u){if(u.success){window.onbeforeunload=function(){return mymailL10n.onbeforeunloadexport};var t=e(".performance").val();c(0,t,u.count,s)}else{alert(u.msg)}},function(t,v,u){alert(v)});return false});e("#delete-subscribers").on("submit",function(){var s=prompt(mymailL10n.confirm_delete,"");if(!s){return false}if("delete"==s.toLowerCase()){var t=e(this).serialize();f.show().removeClass("finished error");e(".step1").slideUp();g.stop().animate({width:"99%"},25000);b("delete_contacts",{data:t},function(u){if(u.success){g.stop().animate({width:"100%"},200,function(){e(".delete-status").html(u.msg);f.addClass("finished")})}else{g.stop();e(".delete-status").html(u.msg);f.addClass("error")}},function(u,w,v){g.stop();e(".delete-status").html("["+u.status+"] "+v);f.addClass("error")})}return false});e("input.selectall").on("change",function(){var t=e(this),s=t.attr("name");e('input[name="'+s+'"]').prop("checked",t.prop("checked"))});function c(y,u,w,x){var v=new Date().getTime(),s=(Math.min(1,(u*y)/w)*100);a.html(i(mymailL10n.prepare_download,""));b("do_export",{limit:u,offset:y,data:x},function(t){var z=s>=100&&t.finished;if(t.success){if(!z){c(y+1,u,w,x)}g.stop().animate({width:(s)+"%"},{duration:z?100:(new Date().getTime()-v)*0.9,easing:"swing",queue:false,step:function(A){a.html(i(mymailL10n.prepare_download,Math.ceil(A)+"%"))},complete:function(){a.html(i(mymailL10n.prepare_download,Math.ceil(s)+"%"));if(z){window.onbeforeunload=null;f.addClass("finished");e(".step2-body").html(mymailL10n.download_finished);a.html(mymailL10n.downloading);if(t.filename){setTimeout(function(){document.location=t.filename},1000)}}else{e(".step2-body").html(i(mymailL10n.write_file,t.total))}}})}else{}},function(t,A,z){})}function q(w,u){var v=new Date().getTime(),s=0;if(!w){w=0}b("do_import",{id:w,options:u},function(t){s=(Math.min(1,(t.imported+t.errors)/t.total)*100);e(".step2-body").html("<p>"+j(t.f_imported,t.f_errors,t.f_total,s,t.memoryusage)+"</p>");k=0;var x=s>=100;if(t.success){if(!x){q(w+1,u)}g.stop().animate({width:(s)+"%"},{duration:x?100:(new Date().getTime()-v)*0.9,easing:"swing",queue:false,step:function(y){o.html(i(mymailL10n.import_contacts,Math.ceil(y)+"%"))},complete:function(){o.html(i(mymailL10n.import_contacts,Math.ceil(s)+"%"));if(x){window.onbeforeunload=null;f.addClass("finished");e(".step2-body").html(t.html).slideDown()}}})}else{r(s,w,u)}},function(t,y,x){r(s,w,u)})}function d(){f.removeClass("finished error");b("get_import_data",{identifier:n},function(s){f.hide().removeClass("finished");e(".step1").slideUp();e(".step2-body").html(s.html).parent().show();e("input.datepicker").datepicker({dateFormat:"yy-mm-dd",showAnim:"fadeIn",onClose:function(){}});o.html("");m=s.data})}function r(s,x,u){k++;if(k>=5){alert(mymailL10n.error_importing);window.onbeforeunload=null;return}var v=k*5,w="",t=setInterval(function(){if(v<=0){clearInterval(t);f.removeClass("paused");q(x,u);w=Math.round(s)+"%"}else{f.addClass("paused");w='<span class="error">'+i(mymailL10n.continues_in,(v--))+"</span>"}o.html(i(mymailL10n.import_contacts,w))},1000)}function j(w,y,v,t,s){var x=new Date().getTime()-p.getTime(),u=Math.ceil(((100-t)*(x/t))/60000);return i(mymailL10n.current_stats,"<strong>"+w+"</strong>","<strong>"+v+"</strong>","<strong>"+y+"</strong>","<strong>"+s+"</strong>")+"<br>"+i(mymailL10n.estimate_time,u)}function b(u,t,v,s){if(e.isFunction(t)){if(e.isFunction(v)){s=v}v=t;t={}}e.ajax({type:"POST",url:ajaxurl,data:e.extend({action:"mymail_"+u,_wpnonce:h},t),success:function(x,y,w){v&&v.call(this,x,y,w)},error:function(w,y,x){if(y=="error"&&!x){return}if(console){console.error(e.trim(w.responseText))}s&&s.call(this,w,y,x)},dataType:"JSON"})}function i(){var s=Array.prototype.slice.call(arguments),t=s.shift();while(s.length){t=t.replace("%s",s.shift())}return t}});